# P-Chain and C-Chain Mempool Gossiping 

Both P-chain and C-chain VMs have mempools which track unconfirmed transactions, waiting to be issued into blocks. These mempools are volatile, i.e. they do not persist unconfirmed transactions; moreover, by default, they only host local transactions issued against their node and are not opened to unconfirmed transactions generated by other nodes. 

In conjunction with the introduction of the Snowman++](https://github.com/ava-labs/avalanchego/tree/master/vms/proposervm#readme) congestion control mechanism, we have opened up both P-chain and C-chain mempools to the respective networks, allowing the gossiping of local transactions as well as the hosting of remote ones. This brief document illustrates how the P-chain and C-chain mempool gossiping is carried out.

## Mempool Gossiping workflow

P-chain and C-chain gossiping mechanisms are slightly different, to adapt to the different structure of their VMs. They share, however, the following workflow:

- One or multiple unconfirmed transactions are accepted into `node A`'s mempool; immediately `node A` gossips around the transactions IDs encoding them into a `AppGossip` message. The node's engine randomly selects a number of validator peers (currently `20`) to send the unsolicited `AppGossip` message to.
- Once `node B` learns about the existence of some remote transaction IDs, it checks whether its mempool contains the transactions or whether they have been recently rejected. If all transactions IDs are already known, the `AppGossip` message is simply dropped. If some transaction IDs are not known, `node B` issues an `AppRequest` message for the unknown transaction IDs to the node from which it received the `AppGossip` (`node A` in this scenario), in order to receive the full transactions. `node B` tracks the content of requests issued by their `requestID` for subsequent verifications.
-  Upon reception of an `AppRequest` message, `node A` tries to fetch the full transactions requested in the `AppRequest` message from its mempool. Note that the transactions advertised in the `AppGossip` message may not be anymore in the mempool, because they could have been included into a block, rejected or dropped. If some transactions are retrieved, they are encoded into an `AppResponse`. The `AppResponse` message carries the same `requestID` of the originating `AppRequest` message and it gets sent back to `node B`.
- Once `node B` receives the `AppResponse` message, it decodes the transactions contained into it and verifies that their IDs match the content requested in the originating `AppRequest` messages. If content matches, transactions are validated and accepted into the mempool.
- If the newly learned transactions are valid and accepted into the mempool a new round of `AppGossip` messages is sent around by `node B` to further propagate the transactions through the network. Note that the original `node A` could appear among the peers selected for the second round of `AppGossip` messages; in this case `node A` will simply drop the message.
- It may happen that `node A` receives an `AppRequest` for a transactions which is not anymore in its mempool (it may have been already committed to a block for instance). In such case `node A` will ignore the `AppRequest` message; `node B` will receive an `AppRequestFailure` message from its engine when a suitable time has passed without hearing from `node A`. In such case `node B` does nothing and do not attempt anymore to learn about the transaction.

Note that no banning mechanism specific to mempool gossiping has been introduced for misbehaving nodes sending around high rates of malformed or invalid transactions. The throttling mechanisms already deployed VM-wide protect mempool related communications from DoS attacks along with any other VM communications.

Two activation times, one per VM, have been introduced to independently activate the mempool gossiping mechanisms.

## P-chain and C-chain gossiping nuances

We list above the details which differ in P-chain and C-chain mempool gossiping:

+ In P-Chain VM, only one transaction ID at a time is gossiped around via `AppGossip` messages.
+ In C-chain VM, it can be gossiped either a single `atomic tx` ID or up to 10 `coreth tx` hashes.
+ In P-Chain VM a transaction received from an `AppResponse` message is only syntactically validated, to make sure it is well-formed; no state related checks are attempted to far. 
+ In C-Chain VM transactions received from an `AppResponse` message are both syntactically validated and checked against the current blockchain state.

Note that in both P-chain and C-chain VMs, the mempools can end up containing mutually incompatible transactions. It is responsibility of  up to the block build mechanism to clear up the mempool incompatibility so to generate valid blocks. 
